<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referral Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 40px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .dashboard { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .login-section { max-width: 400px; margin: 0 auto; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e0e0e0; flex-wrap: wrap; }
        .tab { padding: 15px 25px; background: none; border: none; font-size: 16px; cursor: pointer; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        .tab.hidden { display: none; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; }
        .stat-card h3 { font-size: 14px; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; }
        .stat-card .value { font-size: 36px; font-weight: bold; }
        .code-section { background: #f8f9fa; padding: 30px; border-radius: 15px; margin-bottom: 30px; }
        .code-display { display: flex; align-items: center; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .code { flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 10px; font-size: 28px; font-weight: bold; text-align: center; border: 3px solid #667eea; color: #667eea; letter-spacing: 2px; }
        .btn { padding: 15px 30px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover:not(:disabled) { background: #5568d3; transform: translateY(-2px); }
        .btn-success { background: #48bb78; color: white; }
        .btn-success:hover:not(:disabled) { background: #38a169; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        .link-box { background: white; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px; margin-top: 15px; }
        .link-box input { flex: 1; border: none; background: transparent; padding: 5px; font-size: 14px; }
        .table-container { overflow-x: auto; margin-top: 20px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        .data-table th { background: #f8f9fa; font-weight: 600; color: #333; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-paid { background: #d1fae5; color: #065f46; }
        .alert { padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; }
        .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        .alert-warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
        .alert-error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .hidden { display: none; }
        .payout-card { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; }
        .payout-amount { font-size: 32px; font-weight: bold; color: #667eea; margin: 10px 0; }
        .loading { text-align: center; padding: 40px; color: #999; }
        .toast { position: fixed; top: 20px; right: 20px; min-width: 300px; z-index: 9999; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÅ Referral Dashboard</h1>
            <p>Share, Earn, Get Paid - Now with Auto-Sync to Shopify!</p>
        </div>
        
        <div class="dashboard">
            <!-- LOGIN SECTION -->
            <div id="loginSection" class="login-section">
                <h2 style="margin-bottom: 20px; text-align: center;">Sign In</h2>
                <div class="alert alert-info">
                    <strong>‚ú® New Feature:</strong> Codes automatically sync to Shopify!
                </div>
                <div class="form-group">
                    <label>Your Email</label>
                    <input type="email" id="userEmail" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label>Referral Code (optional)</label>
                    <input type="text" id="existingCode" placeholder="REFER123">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="login()">Access Dashboard</button>
                <p style="margin-top: 15px; text-align: center; color: #666; font-size: 14px;">
                    Don't have a code? One will be created automatically!
                </p>
            </div>
            
            <!-- MAIN DASHBOARD -->
            <div id="mainDashboard" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Welcome! üëã</h2>
                    <button class="btn" onclick="logout()" style="background: #e0e0e0; color: #333;">Logout</button>
                </div>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab(event, 'overview')">Overview</button>
                    <button class="tab" onclick="switchTab(event, 'payouts')">Payouts</button>
                    <button class="tab hidden" id="nonprofitTab" onclick="switchTab(event, 'nonprofit')">Non-Profit</button>
                    <button class="tab hidden" id="adminTab" onclick="switchTab(event, 'admin')">Admin</button>
                </div>
                
                <!-- OVERVIEW TAB -->
                <div id="overview" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card"><h3>Clicks</h3><div class="value" id="totalClicks">0</div></div>
                        <div class="stat-card"><h3>Sales</h3><div class="value" id="totalSales">0</div></div>
                        <div class="stat-card"><h3>Earned</h3><div class="value" id="totalEarned">$0</div></div>
                        <div class="stat-card"><h3>Balance</h3><div class="value" id="availableBalance">$0</div></div>
                    </div>
                    
                    <div class="code-section">
                        <h2>Your Referral Code</h2>
                        <div class="code-display">
                            <div class="code" id="userCode">LOADING</div>
                            <button class="btn btn-primary" onclick="copyCode()">üìã Copy</button>
                        </div>
                        <div class="link-box">
                            <input type="text" id="referralLink" readonly>
                            <button class="btn btn-success" onclick="copyLink()">Copy Link</button>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: #e0e7ff; border-radius: 8px;">
                            <strong>üí° How it works:</strong>
                            <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                                <li>They get <strong id="customerDiscount">10%</strong> off</li>
                                <li>You earn <strong id="commissionRate">10%</strong> commission</li>
                                <li>‚úÖ Code automatically works in Shopify</li>
                            </ul>
                        </div>
                    </div>
                    
                    <h3>Recent Activity</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Commission</th><th>Status</th></tr></thead>
                            <tbody id="activityTable"><tr><td colspan="5" class="loading">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- PAYOUTS TAB -->
                <div id="payouts" class="tab-content">
                    <div class="alert alert-info"><strong>üí∏ Payouts via PayPal - Minimum: $25</strong></div>
                    <div class="payout-card"><h3>Available Balance</h3><div class="payout-amount" id="payoutBalance">$0</div></div>
                    <div class="form-group"><label>PayPal Email</label><input type="email" id="paypalEmail" placeholder="paypal@email.com"></div>
                    <div class="form-group"><label>Amount</label><input type="number" id="withdrawAmount" min="25" step="0.01" placeholder="25.00"></div>
                    <button class="btn btn-success" onclick="requestPayout()">Request Payout</button>
                    <h3 style="margin-top: 40px;">History</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>Date</th><th>Amount</th><th>PayPal</th><th>Status</th></tr></thead>
                            <tbody id="payoutHistory"><tr><td colspan="4" class="loading">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- NONPROFIT TAB -->
                <div id="nonprofit" class="tab-content">
                    <div class="alert alert-info"><strong>üéóÔ∏è Codes without commission tracking - Auto-synced to Shopify</strong></div>
                    <div class="form-group"><label>Non-Profit Name</label><input type="text" id="nonprofitName" placeholder="Animal Shelter"></div>
                    <div class="form-group"><label>Code Prefix</label><input type="text" id="nonprofitPrefix" placeholder="SHELTER" maxlength="10"></div>
                    <div class="form-group"><label>Discount %</label><select id="nonprofitDiscount"><option value="10">10%</option><option value="15">15%</option><option value="20">20%</option><option value="25">25%</option></select></div>
                    <div class="form-group"><label>Notes</label><textarea id="nonprofitNotes" rows="3"></textarea></div>
                    <button class="btn btn-primary" onclick="generateNonprofitCode()">Generate Code</button>
                    <div id="nonprofitResult"></div>
                    <h3 style="margin-top: 40px;">Codes</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>Code</th><th>Name</th><th>Discount</th><th>Created</th><th>Uses</th></tr></thead>
                            <tbody id="nonprofitTable"><tr><td colspan="5" class="loading">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- ADMIN TAB -->
                <div id="admin" class="tab-content">
                    <div class="alert alert-warning"><strong>üîß Admin Panel - Auto-syncs to Shopify</strong></div>
                    <h3>Create Referral Code</h3>
                    <div class="form-group"><label>Email</label><input type="email" id="adminEmail" placeholder="user@email.com"></div>
                    <div class="form-group"><label>Name</label><input type="text" id="adminName" placeholder="John Doe"></div>
                    <div class="form-group"><label>Commission %</label><select id="adminCommission"><option value="5">5%</option><option value="10" selected>10%</option><option value="15">15%</option><option value="20">20%</option></select></div>
                    <div class="form-group"><label>Customer Discount %</label><select id="adminDiscount"><option value="5">5%</option><option value="10" selected>10%</option><option value="15">15%</option><option value="20">20%</option></select></div>
                    <button class="btn btn-primary" onclick="createReferralCode()">Create Code</button>
                    <div id="adminResult"></div>
                    <hr style="margin: 40px 0; border: none; border-top: 2px solid #e0e0e0;">
                    <h3>Record Sale</h3>
                    <div class="form-group"><label>Code</label><input type="text" id="manualCode" placeholder="REFER123"></div>
                    <div class="form-group"><label>Amount $</label><input type="number" id="manualAmount" min="0" step="0.01" placeholder="100.00"></div>
                    <div class="form-group"><label>Order #</label><input type="text" id="manualOrder" placeholder="#1234"></div>
                    <button class="btn btn-success" onclick="recordManualSale()">Record Sale</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // CONFIGURATION - ALREADY CONFIGURED FOR YOU!
        // ============================================
        const CONFIG = {
            GOOGLE_SHEET_URL: 'https://script.google.com/macros/s/AKfycbyDlJJBsjR0rrjOe4Ge5xQNOF-S48GXQRh-fMvBiT-3q32Zsd1wD2gqc7Z8qEjk1ydmwQ/exec',
            SHOPIFY_STORE_URL: 'https://caregivers-support-guide-2.myshopify.com',
            SECRET_KEY: 'my-super-secret-key-xyz123789',
            MIN_PAYOUT: 25
        };
        
        let currentUser = null;
        let sessionToken = null;
        
        // ============================================
        // AUTHENTICATION
        // ============================================
        async function login() {
            const email = document.getElementById('userEmail').value.trim();
            const code = document.getElementById('existingCode').value.trim().toUpperCase();
            
            if (!email || !validateEmail(email)) {
                showToast('error', 'Please enter a valid email');
                return;
            }
            
            try {
                showToast('info', 'Logging in...');
                
                const result = await makeRequest('login', { email, code });
                
                if (!result.success) {
                    showToast('error', result.error || 'Login failed');
                    return;
                }
                
                currentUser = result.data;
                sessionToken = result.data.sessionToken;
                
                localStorage.setItem('referralEmail', email);
                localStorage.setItem('sessionToken', sessionToken);
                
                if (currentUser.isAdmin) {
                    document.getElementById('nonprofitTab').classList.remove('hidden');
                    document.getElementById('adminTab').classList.remove('hidden');
                }
                
                showDashboard();
                loadUserData();
                
                if (currentUser.shopifySynced) {
                    showToast('success', '‚úÖ Your code is ready! It works in Shopify immediately.');
                } else if (currentUser.shopifyError) {
                    showToast('warning', '‚ö†Ô∏è Code created but Shopify sync failed: ' + currentUser.shopifyError);
                } else {
                    showToast('success', 'Welcome! Your referral code has been created.');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showToast('error', 'Connection error. Check CONFIG.GOOGLE_SHEET_URL');
            }
        }
        
        function logout() {
            localStorage.removeItem('referralEmail');
            localStorage.removeItem('sessionToken');
            currentUser = null;
            sessionToken = null;
            document.getElementById('mainDashboard').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            showToast('info', 'Logged out');
        }
        
        // ============================================
        // API REQUESTS
        // ============================================
        async function makeRequest(action, data = {}) {
            const response = await fetch(CONFIG.GOOGLE_SHEET_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action,
                    secretKey: CONFIG.SECRET_KEY,
                    sessionToken: sessionToken,
                    userEmail: currentUser?.email,
                    adminEmail: currentUser?.email,
                    ...data
                })
            });
            
            if (!response.ok) {
                throw new Error('Network error: ' + response.status);
            }
            
            return response.json();
        }
        
        // ============================================
        // UI FUNCTIONS
        // ============================================
        function showDashboard() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
        }
        
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'nonprofit') loadNonprofitCodes();
        }
        
        function showToast(type, message) {
            const toast = document.createElement('div');
            toast.className = `toast alert alert-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 5000);
        }
        
        // ============================================
        // DATA LOADING
        // ============================================
        async function loadUserData() {
            if (!currentUser) return;
            
            document.getElementById('userCode').textContent = currentUser.code;
            document.getElementById('referralLink').value = `${CONFIG.SHOPIFY_STORE_URL}?discount=${currentUser.code}`;
            document.getElementById('customerDiscount').textContent = currentUser.discount + '%';
            document.getElementById('commissionRate').textContent = currentUser.commission + '%';
            
            try {
                const salesResult = await makeRequest('getSales', { code: currentUser.code });
                
                if (!salesResult.success) {
                    showToast('error', 'Error loading sales: ' + salesResult.error);
                    return;
                }
                
                const sales = salesResult.data || [];
                let totalSales = 0, totalEarned = 0, availableBalance = 0;
                
                sales.forEach(sale => {
                    totalSales++;
                    const commission = (sale.amount * currentUser.commission) / 100;
                    totalEarned += commission;
                    if (sale.status !== 'paid') availableBalance += commission;
                });
                
                document.getElementById('totalClicks').textContent = currentUser.clicks || 0;
                document.getElementById('totalSales').textContent = totalSales;
                document.getElementById('totalEarned').textContent = '$' + totalEarned.toFixed(2);
                document.getElementById('availableBalance').textContent = '$' + availableBalance.toFixed(2);
                document.getElementById('payoutBalance').textContent = '$' + availableBalance.toFixed(2);
                
                loadActivityTable(sales);
                loadPayoutHistory();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('error', 'Error loading data');
            }
        }
        
        function loadActivityTable(sales) {
            const tbody = document.getElementById('activityTable');
            
            if (sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999; padding: 40px;">No sales yet - share your code to get started!</td></tr>';
                return;
            }
            
            let html = '';
            sales.forEach(sale => {
                const commission = (sale.amount * currentUser.commission) / 100;
                html += `<tr>
                    <td>${new Date(sale.date).toLocaleDateString()}</td>
                    <td>Sale</td>
                    <td>$${sale.amount.toFixed(2)}</td>
                    <td>$${commission.toFixed(2)}</td>
                    <td><span class="status-badge ${sale.status === 'paid' ? 'status-paid' : 'status-pending'}">${sale.status}</span></td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }
        
        async function loadPayoutHistory() {
            try {
                const result = await makeRequest('getPayouts', { email: currentUser.email });
                const payouts = result.data || [];
                const tbody = document.getElementById('payoutHistory');
                
                if (payouts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999; padding: 40px;">No payouts yet</td></tr>';
                    return;
                }
                
                let html = '';
                payouts.forEach(payout => {
                    html += `<tr>
                        <td>${new Date(payout.date).toLocaleDateString()}</td>
                        <td>$${payout.amount.toFixed(2)}</td>
                        <td>${payout.paypalEmail}</td>
                        <td><span class="status-badge ${payout.status === 'paid' ? 'status-paid' : 'status-pending'}">${payout.status}</span></td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            } catch (error) {
                console.error('Error loading payouts:', error);
            }
        }
        
        async function loadNonprofitCodes() {
            try {
                const result = await makeRequest('getNonprofits');
                const codes = result.data || [];
                const tbody = document.getElementById('nonprofitTable');
                
                if (codes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999; padding: 40px;">No codes yet</td></tr>';
                    return;
                }
                
                let html = '';
                codes.forEach(code => {
                    html += `<tr>
                        <td><strong>${code.code}</strong></td>
                        <td>${code.name}</td>
                        <td>${code.discount}%</td>
                        <td>${new Date(code.created).toLocaleDateString()}</td>
                        <td>${code.uses || 0}</td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            } catch (error) {
                console.error('Error loading nonprofit codes:', error);
            }
        }
        
        // ============================================
        // ACTIONS
        // ============================================
        async function requestPayout() {
            const paypalEmail = document.getElementById('paypalEmail').value.trim();
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            
            if (!paypalEmail || !validateEmail(paypalEmail)) {
                showToast('error', 'Enter valid PayPal email');
                return;
            }
            
            if (!amount || amount < CONFIG.MIN_PAYOUT) {
                showToast('error', `Minimum payout is $${CONFIG.MIN_PAYOUT}`);
                return;
            }
            
            const available = parseFloat(document.getElementById('payoutBalance').textContent.replace('$', ''));
            if (amount > available) {
                showToast('error', 'Insufficient balance');
                return;
            }
            
            if (confirm(`Request payout of $${amount.toFixed(2)} to ${paypalEmail}?`)) {
                try {
                    await makeRequest('createPayout', { email: currentUser.email, paypalEmail, amount });
                    showToast('success', 'Payout requested successfully!');
                    loadUserData();
                    document.getElementById('withdrawAmount').value = '';
                } catch (error) {
                    showToast('error', 'Error requesting payout');
                }
            }
        }
        
        async function generateNonprofitCode() {
            const name = document.getElementById('nonprofitName').value.trim();
            const prefix = document.getElementById('nonprofitPrefix').value.trim().toUpperCase();
            const discount = document.getElementById('nonprofitDiscount').value;
            const notes = document.getElementById('nonprofitNotes').value.trim();
            
            if (!name) {
                showToast('error', 'Enter organization name');
                return;
            }
            
            const code = generateCode(prefix);
            
            try {
                const result = await makeRequest('createNonprofit', { code, name, discount, notes });
                
                if (result.shopifySynced) {
                    document.getElementById('nonprofitResult').innerHTML = `
                        <div class="alert alert-success" style="margin-top: 20px;">
                            <strong>‚úÖ Code Created: ${code}</strong><br>
                            Discount: ${discount}%<br>
                            ‚úÖ Automatically synced to Shopify!
                        </div>`;
                } else {
                    document.getElementById('nonprofitResult').innerHTML = `
                        <div class="alert alert-warning" style="margin-top: 20px;">
                            <strong>‚ö†Ô∏è Code Created: ${code}</strong><br>
                            Discount: ${discount}%<br>
                            Warning: Shopify sync failed
                        </div>`;
                }
                
                document.getElementById('nonprofitName').value = '';
                document.getElementById('nonprofitPrefix').value = '';
                document.getElementById('nonprofitNotes').value = '';
                loadNonprofitCodes();
                
            } catch (error) {
                showToast('error', 'Error creating code');
            }
        }
        
        async function createReferralCode() {
            const email = document.getElementById('adminEmail').value.trim();
            const name = document.getElementById('adminName').value.trim();
            const commission = document.getElementById('adminCommission').value;
            const discount = document.getElementById('adminDiscount').value;
            
            if (!email || !validateEmail(email)) {
                showToast('error', 'Enter valid email');
                return;
            }
            
            try {
                const result = await makeRequest('createReferral', { email, name, commission, discount });
                
                if (result.success) {
                    const referral = result.data;
                    
                    if (referral.shopifySynced) {
                        document.getElementById('adminResult').innerHTML = `
                            <div class="alert alert-success" style="margin-top: 20px;">
                                <strong>‚úÖ Code: ${referral.code}</strong><br>
                                Email: ${email}<br>
                                Commission: ${commission}% | Discount: ${discount}%<br>
                                ‚úÖ Automatically synced to Shopify!
                            </div>`;
                        showToast('success', 'Code created and synced!');
                    } else {
                        document.getElementById('adminResult').innerHTML = `
                            <div class="alert alert-warning" style="margin-top: 20px;">
                                <strong>‚ö†Ô∏è Code: ${referral.code}</strong><br>
                                Email: ${email}<br>
                                Commission: ${commission}% | Discount: ${discount}%<br>
                                Warning: Shopify sync failed
                            </div>`;
                        showToast('warning', 'Code created but sync failed');
                    }
                    
                    document.getElementById('adminEmail').value = '';
                    document.getElementById('adminName').value = '';
                }
                
            } catch (error) {
                showToast('error', 'Error creating code');
            }
        }
        
        async function recordManualSale() {
            const code = document.getElementById('manualCode').value.trim().toUpperCase();
            const amount = parseFloat(document.getElementById('manualAmount').value);
            const orderNum = document.getElementById('manualOrder').value.trim();
            
            if (!code) {
                showToast('error', 'Enter referral code');
                return;
            }
            
            if (!amount || amount <= 0) {
                showToast('error', 'Enter valid amount');
                return;
            }
            
            try {
                await makeRequest('recordSale', { code, amount, orderNum });
                showToast('success', 'Sale recorded!');
                document.getElementById('manualCode').value = '';
                document.getElementById('manualAmount').value = '';
                document.getElementById('manualOrder').value = '';
                if (currentUser) loadUserData();
            } catch (error) {
                showToast('error', 'Error recording sale');
            }
        }
        
        // ============================================
        // UTILITIES
        // ============================================
        function copyCode() {
            navigator.clipboard.writeText(document.getElementById('userCode').textContent);
            showToast('success', 'Code copied!');
        }
        
        function copyLink() {
            navigator.clipboard.writeText(document.getElementById('referralLink').value);
            showToast('success', 'Link copied!');
        }
        
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
        
        function generateCode(prefix = '') {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = prefix;
            for (let i = 0; i < (8 - prefix.length); i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // ============================================
        // AUTO-LOGIN ON PAGE LOAD
        // ============================================
        window.addEventListener('DOMContentLoaded', () => {
            const savedEmail = localStorage.getItem('referralEmail');
            const savedToken = localStorage.getItem('sessionToken');
            
            if (savedEmail) {
                document.getElementById('userEmail').value = savedEmail;
            }
        });
    </script>
</body>
</html>
